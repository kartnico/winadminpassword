#!/usr/bin/perl -w
# $Revision: 1.5 $
# $Id: winadminpassword $
#
# Author: Nicolas BOURGES <nicolas.bourges@isep.fr> #
# Last Modified: Thu August 09 01:00:00 CDT 2011 #
# Description: WinAdminPassword main script #
#
# Licence: GNU GENERAL PUBLIC LICENSE v3 #
# WinAdminPassword - A utility to deploy unique passwords for Microsoft Windows and Unix systems. It is based on the serial number of computers and a secret key. #
# The advantage is that no password is stored in a database. #
# Copyright (C) 2011 Nicolas BOURGES #
# 
# This program is free software: you can redistribute it and/or modify #
# it under the terms of the GNU General Public License as published by #
# the Free Software Foundation, either version 3 of the License, or #
# (at your option) any later version. #
# 
# This program is distributed in the hope that it will be useful, #
# but WITHOUT ANY WARRANTY. without even the implied warranty of #
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the #
# GNU General Public License for more details. #
#
# You should have received a copy of the GNU General Public License #
# along with this program.  If not, see <http://www.gnu.org/licenses/>. #
#########################################################################

use strict;
use warnings;
use Getopt::Long;
use Digest::SHA1 qw(sha1 sha1_hex sha1_base64);
use vars qw($param $params $VERSION $version $help $printserial $changepassword $printpassword $printdate $serial $key $user $password $length $html $color $algo $size $verbose $date $time $secondkey $cron);

$params = "";
$VERSION = "1.5";

BEGIN {
	if ($^O =~ /^(MS)?Win/) {
		eval "use Win32::OLE qw(in);";
		die $@ if $@;
	}
	else {
		eval "use Config::Crontab;";
		die $@ if $@;
	}
}

# Print password in HTML
sub html {
        my ($color, $size, $password) = @_;
        $$password = "<p><font color=".$color." size=".$size." face="."Comic Sans MS, Arial".">".$$password;
        $$password =~ s/!\n/!<br><p>/g;
        $$password =~ s/Ã©/&eacute;/g;
        $$password .= '</font></p>';
}

# Print the manual
sub usage {
print <<__USAGE__;
Usage

winadminpassword [-v] [-h] [--printserial] [--printpassword] [--printdate]
[--changepassword] [-s serial] [-k secretkey] [-u username] [-w password] 
[-l length] [-g] [-a algorith] [-r color] [-z size] [-j] [-o] [-t] [-d date] 
[-x secondkey]

Functions

-v, --version				Displays the script version
-h, --help				This information
-y, --printdate				Print date in WinAdminPassword format
-m, --showserial, --printserial		Print serial number of this computer
-p, --showpasswd, --printpassword	Print password (-k and -l are mandatory)
-c, --chpasswd, --changepassword	Change password for a user (-k, -u, -l 
					are mandatory)

Options

-o, --verbose				Print generated password when you use 
					--changepassword function
-s, --serial=SERIAL			Set the serial number (CASE SENSITIVE)
					default : the serial number of computer 
					where the script is executed
-k, --key=KEY				The very secret key (CASE SENSITIVE)
-x, --skey, --secondkey=KEY		The second key (optional but really 
					useful with the GLPI plugin because it 
					is not stored in the database and it 
					is requested each time to the 
					passwords) you can use a simple 
					passphrase. (CASE SENSITIVE)
					
-u, --user=USER				Set the username of the local account
					to change his password
-w, --passwd, --password=PASSWORD	Set the password if you don't want use 
					the generated password
-l, --length=LENGTH			Set the length of the generated 
					password
-a, --algo=ALGO				Set the algorithm for generating the 
					hash that will be use to generate 
					password
						1 : \$key.\$serial
						2 : \$serial\$key
						3 : \$serial\$key\$serial
						4 : \$key\$serial\$key
						5 : \$key\$serial
						default : 1
-j, --html				Print the output of -p in HTML
-r, --color=COLOR			Set the print color for the html output
					default : orange
-z, --size=SIZE				Set the size for the html output
					default : 16
-t, --time				Add the current time to the hash, in
					order to generate a password based 
					on the system time
-g, --cron				Add the command line to cron, in order 
					to launch it at the beggining of 
					every hours. (Very useful with 
					--time parameter)
-d, --date=DATE				Set the date to find a timed generated
					password use "10.2011.Feb.12" for 
					Feb 12 2011 at 10am
						Months : Jan Feb Mar Apr May 
						Jun Jul Aug Sep Oct Nov Dec
						Hours : 0 1 2 3 4 5 6 7 8 9 
						10 11 12 13 14 15 16 17 18 19 
						20 21 22 23

!! On unix or GNU Linux systems, you must despecialize \$ charaters with \\ in 
your command line

Samples

 PrintSerial :
        # winadminpassword --printserial
                print the serial number of this computer

 ChangePassword :
	# winadminpassword --changepassword -k "myverysecretkey" -l "12" 
	-u "Administrator" -o
                change the password for Administrator account. The password 
		size will be 12. The output will print the generated password

        # winadminpassword --changepassword -k "myverysecretkey" -l "12" -u 
	"root" -t
                change the password for root account. The password size will 
		be 12. The generated password will be based on systemtime. 
		Use -d parameter to find it.

        # winadminpassword --changepassword -k "myverysecretkey" -l "12" 
	-u "root" -t -g
                add this command to cron. Every hour the password will be 
		changed. Use -d parameter to find it.

 PrintPassword :
	# winadminpassword --printpassword -a "2" -s "AB4528CF" 
	-k "myverysecretkey" -l "18" -j -r "red" -z "12"
                print the generated password with myverysecretkey 
		and the second algorithm for the AB4528CF serial. 
		The password size will be 18. The output will be in HTML 
		in red and with size 12

        # winadminpassword --printpassword -l 12 -s "AB4HGD" 
	-k "myverysecretkey" -x "hello" -d "3.2011.Jul.28"
                print the result of timed generated password at 3 Hours 
		in July 28 2011. The second secret key is "hello".
__USAGE__
exit(0);
}

# Get System Time
sub getTime {
	my $systemtime;

	my ($sec,$min,$hour,$mday,$mon,$year,$wday,$yday,$isdst) = localtime(time);
	my @abbr = qw( Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec );	
	$year += 1900;	
	$systemtime="$hour.$year.".$abbr[$mon].".$mday";
	
	return $systemtime;
}

# Get Serial Number
sub serialNum {
	my $SerialNum;  # The serial number

	if ($^O =~ /^(MS)?Win/) {
		my $WMI = Win32::OLE-> GetObject("winmgmts:");

		# Getting the serial number
		my @Results = in($WMI-> ExecQuery("Select SerialNumber from Win32_BIOS"));
		if (!defined $Results[0]) {
			my @Results = in($WMI-> ExecQuery("SELECT SerialNumber from Win32_SystemEnclosure"));
		}
		if (!defined $Results[0]) {
			my @Results = in($WMI-> ExecQuery("SELECT SMBIOSAssetTag from Win32_SystemEnclosure"));
		}
		# Setting the serial number
		$SerialNum = $Results[0]-> {SerialNumber};
	}
	else {
		# Must be root
		if ( $< == 0 ) {		
			# Getting the serial number with dmidecode on unix systems ( #TODO : Add path to cron regarding the system )
			$SerialNum = `/usr/sbin/dmidecode -s system-serial-number`;
		}
		else {
			print "You must be root in order to get serial number of this computer ! If you want to change password of a non admin user, you can use -s parameter\n";
			exit(0);
		}
	}

	# Remove any newline character from the end of a string
	chomp($SerialNum);

	# Returning serial number
	return $SerialNum;
}

# Change local admin password
sub genPassword {
	my ($serial, $length, $key, $algorithm) = @_;
	my $hash;

	# Select algorithm to gen the hash
	if ( $algorithm == "1" ) { $hash = "$key.$serial"; }
	elsif ( $algorithm == "2" ) { $hash = "$serial$key"; }
	elsif ( $algorithm == "3" ) { $hash = "$serial$key$serial"; }
	elsif ( $algorithm == "4" ) { $hash = "$key$serial$key"; }
	elsif ( $algorithm == "5" ) { $hash = "$key$serial"; }
	else { $hash = "$key.$serial"; }
	
	# Encoding in sha1 base 64
	my $digest = sha1_base64($hash);

	# Gen Password with selected length
	my $password = substr $digest, 0, $length;

        # Delete "/", "\" and "&" characters
	$password =~ s/\//\-/g;
	$password =~ s/\\/\!/g;
	$password =~ s/\&/\+/g;

	return $password;
}

sub changePassword {	
	my ($user, $password) = @_;

	## Change password
	# For Windows
	if ($^O =~ /^(MS)?Win/) {	
		system '%windir%\system32\net.exe user '.$user.' "'.$password.'"';
	}
	# For Unix
	else {
		system 'echo "'.$user.':'.$password.'" | /usr/sbin/chpasswd'; #TODO : Add path to cron regarding the system
	}
}

# Get commandline
foreach $param (@ARGV) {
	if ($param =~ m/ /) {
		$params = $params." \"".$param."\" ";
	}
	else {
		$params = $params." ".$param." ";
	}
}

# Get parameters
GetOptions ('p|printpassword|showpasswd' => \$printpassword, 'v|version' => \$version, 'h|help' => \$help, 'c|changepassword|chpasswd' => \$changepassword, 's|serial=s' => \$serial, 'k|key=s' => \$key, 'w|passwd|password=s' => \$password, 'l|length=i' => \$length, 'm|printserial|showserial' => \$printserial, 'j|html' => \$html, 'a|algo=i' => \$algo, 'u|user=s' => \$user, 'r|color=s' => \$color, 'z|size=i' => \$size, 'o|verbose' => \$verbose, 't|time' => \$time, 'd|date=s' => \$date, 'x|secondkey|skey=s' => \$secondkey, 'g|cron' => \$cron, 'y|printdate' => \$printdate) or usage();

# Functions
if ($version) { print "winadminpassword version $VERSION\n"; exit(0); }
elsif ($help) { usage(); exit(0); }
elsif ($printdate) {
	my $systemDate=getTime();
	print "$systemDate\n";
}
elsif ($printserial) {
	my $serial=serialNum();
	print "$serial\n";
}
elsif ($printpassword) {
	my $serialNum;
	my $algorithm;
	my $printColor;
	my $printSize;
	my $now;

	if (!defined $key) { usage(); exit(0); }
	if (!$length) { usage(); exit(0); }

	if (!$algo) { 
		$algorithm = "1"; 
	}
	else { 
		$algorithm=$algo; 
	}

	if (!defined $serial) {
		$serialNum=serialNum();
	}
	else {
		$serialNum=$serial;
	}

	if($time) {
		$now=getTime();
		$key="$key$now";
	}
	elsif($date) {
		$key="$key$date";
	}

	if(defined $secondkey) {
		$key="$key$secondkey";
	}
	
	# Gen Password
	my $password=genPassword("$serialNum", "$length", "$key", "$algorithm");
	
	# Print password
        if ($html) {
		if (!$color) {
			$printColor="orange";
		}
		else {
			$printColor="$color";
		}

		if (!$size) {
			$printSize="16";
		}
		else {
			$printSize="$size";
		}

                html($printColor, $printSize, \$password);
                print $password;
        }
        else {
                print "$password\n";
        }
}
elsif ($changepassword) {
	my $serialNum;
	my $passwordGen;
	my $algorithm;
	my $timeHash;
	my $login;
	my $block;

	if (!defined $user) { usage(); exit(0); }
	if (!defined $password) {
		if (!defined $key) { usage(); exit(0); }
	        if (!$length) { usage(); exit(0); }

	        if (!defined $serial) {
			$serialNum=serialNum();
		}
		else {
			$serialNum=$serial;
		}
		
		if (!$algo) {
        	        $algorithm = "1";
	        }
	        else {
	                $algorithm=$algo;
	        }

		if($time) {
			$timeHash=getTime();
			$key="$key$timeHash";
		}

		if(defined $secondkey) {
			$key="$key$secondkey";
		}
	
        	$passwordGen=genPassword("$serialNum", "$length", "$key", "$algorithm");
	}
	else {
		$passwordGen=$password;
	}
	changePassword("$user","$passwordGen");

	if ($cron) {
	        # Get command line base without -g, --cron and -o, --verbose
		$params =~ s/--cron//g;
		$params =~ s/--verbose//g;
		$params =~ s/\ -o\ /\ /g;
                $params =~ s/\ -g\ /\ /g;

		# Microsoft Windows : Add to Task Scheduler (#TODO : Verify if task exists)
		if ($^O =~ /^(MS)?Win/) {
			my ($seco,$minu,$hours,$mdays,$mont,$years,$wdays,$ydays,$isdsts) = localtime(time);
			my @ahour = qw( 00 01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16 17 18 19 20 21 22 23 00 );

			# Despecialize characters from command line
			$params =~ s/"/\\"/g;
			# Add 1h
			$hours += 1;

			# If x86 installation on x64 system
			if(-e "c:/Program Files (x86)/WinAdminPassword/winadminpassword.pl") {
				# If Windows NT 6.x
				if (-e "c:/users/public") {
					system '%windir%\system32\schtasks.exe /create /f /ru "SYSTEM" /tn winadminpassword-'.$user.' /tr "perl \"c:\Program Files (x86)\WinAdminPassword\winadminpassword.pl\" '.$params.'" /sc HOURLY /st '.$ahour[$hours].':00:00';
				}
				else {
					system '%windir%\system32\schtasks.exe /create /ru "SYSTEM" /tn winadminpassword-'.$user.' /tr "perl \"c:\Program Files (x86)\WinAdminPassword\winadminpassword.pl\" '.$params.'" /sc HOURLY /st '.$ahour[$hours].':00:00';
					system '%windir%\system32\schtasks.exe /change /ru "SYSTEM" /tn winadminpassword-'.$user.' /tr "perl \"c:\Program Files (x86)\WinAdminPassword\winadminpassword.pl\" '.$params.'"';
				}
			}
			else {
				# If Windows NT 6.x
				if (-e "c:/users/public") {
					system '%windir%\system32\schtasks.exe /create /f /ru "SYSTEM" /tn winadminpassword-'.$user.' /tr "perl \"%programfiles%\WinAdminPassword\winadminpassword.pl\" '.$params.'" /sc HOURLY /st '.$ahour[$hours].':00:00';
				}
				else {
					system '%windir%\system32\schtasks.exe /create /ru "SYSTEM" /tn winadminpassword-'.$user.' /tr "perl \"%programfiles%\WinAdminPassword\winadminpassword.pl\" '.$params.'" /sc HOURLY /st '.$ahour[$hours].':00:00';
					system '%windir%\system32\schtasks.exe /change /ru "SYSTEM" /tn winadminpassword-'.$user.' /tr "perl \"%programfiles%\WinAdminPassword\winadminpassword.pl\" '.$params.'"';
				}
			}
		}
		# Else : Add to crontab
		else {
			# Despecialize characters from command line
                        $params =~ s/\$/\\\$/g;

			# Get username who execute script
			$login = getpwuid($<);		
	
			my $ct = new Config::Crontab( -owner => ''.$login.'' );
			$ct->read;

			## Remove old block
			$ct->remove($ct->block($ct->select(-command_re => "winadminpassword")));

			## Using Block methods
			$block = new Config::Crontab::Block;
			$block->last( new Config::Crontab::Comment( -data => '## WinAdminPassword' ) );
			$block->last( new Config::Crontab::Event( -minute  => 0,
	                                		          -command => ''.$0.$params.'' ) );
			## add this block to crontab file
			$ct->last($block);
	
			## write out crontab file
			$ct->write;
		}
	}

	if ($verbose) { print "New password for $user: $passwordGen\n"; }
}
else { usage(); }

__END__

=head1 NAME

WinAdminPassword

=head1 DESCRIPTION

Tool for the deployment of unique passwords for Windows and Unix systems. It is based on the serial number of computers and a secret key. The advantage is that no password is stored in a database and you can display them with a GLPI plugin, Webmin...

Features

    - Generate passwords based on a secret key and computers serial numbers
    - Generate passwords based on the system time
    - Display generated passwords
    - Change user passwords on Microsoft Windows and Unix systems
    - Print serial number on Microsoft Windows and Unix systems
    - Add a system task (cron) to change password periodically

=head1 SYNOPSIS

	winadminpassword [-v] [-h] [--printserial] [--printpassword] [--changepassword] [--printdate] [-s serial] [-k secretkey] [-u username] [-w password] [-l length] [-a algorith] [-r color] [-z size] [-j] [-o] [-t] [-d date] [-x secondsecretkey] [-g]

=head1 FUNCTIONS

 -v, --version                          Displays the script version
 -h, --help                             This information
 -y, --printdate                        Print date in WinAdminPassword format
 -m, --showserial, --printserial        Print serial number of this computer
 -p, --showpasswd, --printpassword      Print password (-k and -l are mandatory)
 -c, --chpasswd, --changepassword       Change password for a user (-k, -u and -l are mandatory)

=head1 OPTIONS

 -o, --verbose                          Print generated password when you use --changepassword function
 -s, --serial=SERIAL                    Set the serial number
                                        default : the serial number of computer where the script is executed
 -k, --key=KEY                          The very secret key
 -x, --skey, --secondkey=KEY            The second key (optional but really useful with the GLPI plugin because it is not stored in the database and
                                        it is requested each time to the passwords) you can use a simple passphrase
 -u, --user=USER                        Set the username of the local account to change his password
 -w, --passwd, --password=PASSWORD      Set the password if you don't want use the generated password
 -l, --length=LENGTH                    Set the length of the generated password
 -a, --algo=ALGO                        Set the algorithm for generating the hash that will be use to generate password
                                                1 : \$key.\$serial
                                                2 : \$serial\$key
                                                3 : \$serial\$key\$serial
                                                4 : \$key\$serial\$key
                                                5 : \$key\$serial
                                                default : 1
 -j, --html                             Print the output of --printpassword in HTML
 -r, --color=COLOR                      Set the print color for the html output
                                        default : orange
 -z, --size=SIZE                        Set the size for the html output
                                        default : 16
 -t, --time                             Add the current time to the hash, in order to generate a password based on the system time
 -g, --cron                             Add the command line to cron, in order to launch it at the beggining of every hours. (Very useful with --time parameter)
 -d, --date=DATE                        Set the date to find a timed generated password use "10.2011.Feb.12" for Feb 12 2011 at 10am
                                                Months : Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec
                                                Hours : 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23

!! On unix or GNU Linux systems, you must despecialize $ charaters with \ in your command line

=head1 SAMPLES

 PrintSerial :
        # winadminpassword --printserial
                print the serial number of this computer

 PrintDate :
        # winadminpassword --printdate
                print the current system date in WinAdminPassword format

 ChangePassword :
        # winadminpassword --changepassword -k "myverysecretkey" -l "12" -u "Administrator" -o
                change the password for Administrator account. The password size will be 12. The output will print the generated password

        # winadminpassword --changepassword -k "myverysecretkey" -l "12" -u "root" -t
                change the password for root account. The password size will be 12. The generated password will be based on systemtime. Use -d parameter to find it.

        # winadminpassword --changepassword -k "myverysecretkey" -l "12" -u "root" -t -g
                add this command to cron. Every hour the password will be changed. Use -d parameter to find it.

 PrintPassword :
        # winadminpassword --printpassword -a "2" -s "AB4528CF" -k "myverysecretkey" -l "18" -j -r "red" -z "12"
                print the generated password with myverysecretkey and the second algorithm for the AB4528CF serial. The password size will be 18. The output will be in HTML in red and with size 12

        # winadminpassword --printpassword -l 12 -s "AB4HGD" -k "myverysecretkey" -x "hello" -d "3.2011.Jul.28"
                print the result of timed generated password at 3 Hours in July 28 2011. The second secret key is "hello".

=head1 BUGS

Bugs? We don't write no stinking bugs!

Please report anything odd to the author.

=head1 DEPENDENCIES

	- ActivePerl on Microsoft Windows systems
	- dmidecode, Perl, Config::Contab and Digest::SHA1 on Unix systems

=cut
